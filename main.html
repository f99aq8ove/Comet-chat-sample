<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>COMET sample</title>
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <script type="text/javascript">google.load("jquery", "1");</script>
        <script type="text/javascript">
$(function(){
    $("#chat").submit(function() {
        $.post("/post", $("#chat").serialize());
        $("#chat input[name=text]").val('').focus();
        return false;
    });

    var base_title = document.title;
    var focus_out;
    var unread = 0;
    $("body").focusout(function() { focus_out = true; unread = 0; });
    $("body").bind("focusin.changetitle", function() { focus_out = false; change_title(unread); });
    var change_title = function(title) {
        document.title = (focus_out ? "(" + title + ") " : "") + base_title;
    };

    var new_messages = function(msgs) {
        var url_chars = "-_.!~*'()a-zA-Z0-9;?:@&=+$,%#";
        var tokenize_regex = new RegExp("(s?https?:\/\/[" + url_chars + "/]+)");
        var url_regex = new RegExp("^(s?https?):\/\/([" + url_chars + "]+)(?:/([" + url_chars + "/]*))?$")
        var tokenizer = function(str, regex) {
            var splits = new Array;
            var m;
            while (m = regex.exec(str)){
                var begin = m.index;
                var end = m.index + m[0].length;
                splits.push(str.slice(0, begin));
                splits.push(str.slice(begin, end));
                str = str.slice(end);
            }
            splits.push(str);
            return splits;
        };

        var make_text_elm = function(text) {
            var elm = $("<div />");
            $.each(tokenizer(text, tokenize_regex), function() {
                var uri = this.match(url_regex);
                if (uri) {
                    var anchor_string = (uri[1] != "http" ? uri[1] + "://" : "") + uri[2] + (uri[3] ? "/..." : "");
                    elm.append($("<a />").attr({ href: this, title: this }).append(document.createTextNode(anchor_string)));
                } else {
                    elm.append(document.createTextNode(this));
                }
            });
            return elm;
        };

        if (focus_out && unread == 0) {
            $("#message").prepend($("<hr />"));
        }
        $.each(msgs, function() {
            last_id = this.id;
            var hoge = $("#message").prepend($("<div />")
                .append($("<div />").text(this.name).css({
                    float: "left",
                    padding: "0.2em",
                    width: "6em",
                    backgroundColor: "#eef"
                }))
                .append(make_text_elm(this.text).css({ float: "left", marginLeft: "0.5em" }))
                .append($("<div />").text((new Date(this.time * 1000)).toLocaleString()).css("float", "right"))
                .append($("<div />").css("clear", "both"))
                .css("border-bottom", "1px solid #eee")
            );
            change_title(++unread);
        });
    };

    var last_id;
    var retries_remaining;
    (function() {
        var self_func = arguments.callee;
        var error_handler = function() {
            if (retries_remaining-- > 0) {
                $('#notice').css("background-color", "yellow").text("Reconnecting...").slideDown().delay(10000).slideUp();
                setTimeout(self_func, 10000);
            } else {
                $('#notice').css("background-color", "red").text("Network error. Please reload.").slideDown();
                $("body").unbind("focusin.changetitle");
                change_title("!");
                alert("Network error. Please reload.");
            }
        };
        $.get("/get?last_id=" + last_id + '&dummy=' + (new Date()).getTime(), function(data) {
            retries_remaining = 10;

            if (!data) {
                error_handler();
                return;
            }
            new_messages(data);
            self_func();
        }, "json").error(error_handler);
    })();

    var get_cookie = function(k) {
        if (!document.cookie) return "";
        var cookies = {};
        $.each(document.cookie.split(/;\s*/), function() {
                var tmp = this.split(/=/);
                cookies[unescape(tmp[0])] = unescape(tmp[1]);
                });
        return cookies[k] || "";
    };

    var set_cookie = function(key, value, opt) {
        if (!opt) {
            opt = {};
        }
        var tmp = new Array();
        $.each(opt, function(k, v) {
                tmp.push(k + "=" + v);
                });
        document.cookie = escape(key) + "=" + escape(value) + "; " + tmp.join("; ");
    };

    $("#chat input[name=name]").val(get_cookie("NAME")).focusout(function() {
            set_cookie("NAME", $(this).val(), { expires: (new Date((new Date()).getTime() + 7 * 24 * 60 * 60 * 1000)).toUTCString() });
            });

    $(window).resize(function() {
            var textbox = $("#chat input[name=text]");
            textbox.width($("html").innerWidth()
                - $("#chat input[name=name]").outerWidth()
                - $("#chat input[name=submit]").outerWidth()
                - 70);
            }).resize();
});
        </script>
    </head>
    <body>
        <div id="notice" style="padding: 0.5em; margin: 0.5em; display: none"></div>
        <div>
            <form id="chat">
                <input type="text" name="name" size="8" />
                <input type="text" name="text" size="100"/ >
                <input type="submit" name="submit" value="send" />
            </form>
        </div>
        <div id="message"></div>
    </body>
</html>
