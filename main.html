<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>COMET sample</title>
        <script type="text/javascript" src="https://www.google.com/jsapi"></script>
        <script type="text/javascript">google.load("jquery", "1");</script>
        <script type="text/javascript">
$(function(){
    $("#chat").submit(function() {
        $.post("/post", $("#chat").serialize());
        $("#chat input[name=text]").val('').focus();
        return false;
    });

    var base_title = document.title;
    var focus_out;
    var unread = 0;
    $("body").focusout(function() { focus_out = true; unread = 0; });
    $("body").focusin(function()  { focus_out = false; change_title(unread); });
    var change_title = function(title) {
        document.title = (focus_out ? "(" + title + ") " : "") + base_title;
    };

    var last_id;
    (function() {
        $.get("/get?last_id=" + last_id + '&dummy=' + (new Date()).getTime(), function(data) {
            if (focus_out && unread == 0) {
                $("#message").prepend($("<hr />"));
            }
            $.each(data, function() {
                last_id = this.id;
                $("#message").prepend($("<div />").text(
                        "(" + (new Date(this.time * 1000)).toLocaleString() + ") " + this.name + " : " + this.text)
                    );
                change_title(++unread);
            });
        }, "json").success(arguments.callee).error(function() {
            alert("got error. please reload.")
        });
    })();

    var get_cookie = function(k) {
        if (!document.cookie) return {};
        var cookies = {};
        $.each(document.cookie.split(/;\s*/), function() {
                var tmp = this.split(/=/);
                cookies[unescape(tmp[0])] = unescape(tmp[1]);
                });
        return cookies[k];
    };

    var set_cookie = function(k, v) {
        document.cookie = escape(k) + "=" + escape(v);
    };

    $("#chat input[name=name]").val(get_cookie("NAME")).focusout(function() {
            set_cookie("NAME", $(this).val());
            });
});
        </script>
    </head>
    <body>
        <form id="chat">
            <input type="text" name="name"></input>
            <input type="text" name="text" size="100"></input>
            <input type="submit" value="send"></input>
        </form>
        <div id="message"></div>
    </body>
</html>
